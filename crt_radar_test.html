<!DOCTYPE html>
<html>
<head>
    <title>P7 Phosphor CRT Radar Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #000;
            font-family: monospace;
            color: #0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        h1 {
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
        }
        
        /* CRT Display Container - simulates physical radar scope */
        .crt-display-container {
            position: relative;
            display: inline-block;
            background: #000;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 
                inset 0 0 50px rgba(0,255,100,0.1),
                0 0 100px rgba(0,0,0,0.9);
        }

        /* CRT Bezel - simulates the physical screen frame */
        .crt-bezel {
            position: relative;
            background: radial-gradient(ellipse at center, #000 0%, #111 70%, #000 100%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 
                inset 0 0 30px rgba(0,255,100,0.15),
                inset 0 0 60px rgba(0,255,100,0.05);
        }

        /* Canvas wrapper with CRT effects */
        .crt-screen {
            position: relative;
            overflow: hidden;
            border-radius: 5px;
        }

        /* The actual radar canvas */
        .crt-screen canvas {
            display: block;
            background: #000;
            /* Phosphor glow effect */
            filter: 
                blur(0.3px)
                brightness(1.1)
                contrast(1.2);
        }

        /* Scanline overlay - creates horizontal lines like a real CRT */
        .crt-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 10;
        }

        /* Screen curvature and vignette effect */
        .crt-screen::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: radial-gradient(
                ellipse at center,
                transparent 0%,
                transparent 60%,
                rgba(0, 0, 0, 0.3) 85%,
                rgba(0, 0, 0, 0.7) 100%
            );
            border-radius: 5px;
            z-index: 11;
        }
        
        .info {
            margin-top: 20px;
            text-align: center;
            color: #0a0;
        }
    </style>
</head>
<body>
    <h1>P7 Phosphor CRT Radar Display Test</h1>
    <p class="info">Inspired by masswerk.at's PDP-1 Type 30 CRT emulation</p>
    
    <div class="crt-display-container">
        <div class="crt-bezel">
            <div class="crt-screen">
                <canvas id="radar-scope-canvas" width="800" height="800"></canvas>
            </div>
        </div>
    </div>
    
    <div class="info">
        <p>Features:</p>
        <p>✓ P7 Phosphor (blue flash + green persistence)</p>
        <p>✓ Scanlines</p>
        <p>✓ Vignette effect</p>
        <p>✓ Authentic radar sweep with trails</p>
    </div>

    <script>
// Enhanced CRT rendering with P7 phosphor simulation
class CRTRadarScope {
    constructor(canvasId) {
        this.canvas = document.getElementById(canvasId);
        if (!this.canvas) {
            console.error('[CRT] Canvas not found:', canvasId);
            return;
        }
        
        this.ctx = this.canvas.getContext('2d', { alpha: false });
        this.width = this.canvas.width;
        this.height = this.canvas.height;
        
        // P7 Phosphor colors (inspired by real CRT phosphor)
        // P7 has two components: fast blue decay + slow green persistence
        this.phosphorFast = 'rgba(100, 150, 255, 0.9)';  // Blue, fast decay
        this.phosphorSlow = 'rgba(0, 255, 100, 0.8)';    // Green, slow persistence
        this.phosphorPersistence = 'rgba(0, 255, 100, 0.3)'; // Fading trail
        
        // Persistence layer for phosphor trails
        this.persistenceCanvas = document.createElement('canvas');
        this.persistenceCanvas.width = this.width;
        this.persistenceCanvas.height = this.height;
        this.persistenceCtx = this.persistenceCanvas.getContext('2d', { alpha: true });
        
        // Radar state
        this.tracks = [];
        this.overlays = new Set(['range_rings', 'coastlines']);
        this.geoData = null;
        this.sweepAngle = 0;
        this.brightness = 0.75;
        this.centerX = this.width / 2;
        this.centerY = this.height / 2;
        
        // Phosphor persistence decay rate (per frame)
        this.persistenceDecay = 0.97;  // Higher = longer persistence
        
        // Animation
        this.lastFrameTime = Date.now();
        this.sweepSpeed = 6.0; // degrees per second
        
        console.log('[CRT] Initialized with P7 phosphor simulation');
        requestAnimationFrame(() => this.render());
    }
    
    render() {
        const now = Date.now();
        const dt = (now - this.lastFrameTime) / 1000;
        this.lastFrameTime = now;
        
        // Update sweep angle
        this.sweepAngle = (this.sweepAngle + this.sweepSpeed * dt) % 360;
        
        // Apply phosphor persistence decay
        this.persistenceCtx.globalCompositeOperation = 'source-over';
        this.persistenceCtx.fillStyle = `rgba(0, 0, 0, ${1 - this.persistenceDecay})`;
        this.persistenceCtx.fillRect(0, 0, this.width, this.height);
        
        // Clear main canvas
        this.ctx.fillStyle = '#000';
        this.ctx.fillRect(0, 0, this.width, this.height);
        
        // Draw persistence layer (long-lasting green phosphor)
        this.ctx.drawImage(this.persistenceCanvas, 0, 0);
        
        // Draw range rings (onto persistence layer for glow)
        if (this.overlays.has('range_rings')) {
            this.drawRangeRings();
        }
        
        // Draw sweep with phosphor effect
        this.drawSweep();
        
        // Draw tracks with dual-phosphor effect
        this.drawTracks();
        
        requestAnimationFrame(() => this.render());
    }
    
    drawRangeRings() {
        const rings = [50, 100, 150, 200, 250, 300, 350];
        
        // Draw onto persistence layer for permanent glow
        this.persistenceCtx.strokeStyle = this.phosphorPersistence;
        this.persistenceCtx.lineWidth = 1;
        
        rings.forEach(radius => {
            this.persistenceCtx.beginPath();
            this.persistenceCtx.arc(this.centerX, this.centerY, radius, 0, Math.PI * 2);
            this.persistenceCtx.stroke();
        });
    }
    
    drawSweep() {
        // Sweep creates a fading arc effect
        const sweepLength = 350;
        const angleRad = (this.sweepAngle * Math.PI) / 180;
        
        // Draw bright leading edge (fast blue phosphor)
        const gradient = this.ctx.createRadialGradient(
            this.centerX, this.centerY, 0,
            this.centerX, this.centerY, sweepLength
        );
        gradient.addColorStop(0, this.phosphorFast);
        gradient.addColorStop(0.7, this.phosphorSlow);
        gradient.addColorStop(1, 'rgba(0, 255, 100, 0)');
        
        this.ctx.save();
        this.ctx.translate(this.centerX, this.centerY);
        this.ctx.rotate(angleRad);
        
        // Draw sweep line with glow
        this.ctx.strokeStyle = gradient;
        this.ctx.lineWidth = 3;
        this.ctx.shadowBlur = 20;
        this.ctx.shadowColor = this.phosphorSlow;
        this.ctx.beginPath();
        this.ctx.moveTo(0, 0);
        this.ctx.lineTo(sweepLength, 0);
        this.ctx.stroke();
        
        this.ctx.restore();
        
        // Add sweep line to persistence layer
        this.persistenceCtx.save();
        this.persistenceCtx.translate(this.centerX, this.centerY);
        this.persistenceCtx.rotate(angleRad);
        this.persistenceCtx.strokeStyle = this.phosphorPersistence;
        this.persistenceCtx.lineWidth = 2;
        this.persistenceCtx.beginPath();
        this.persistenceCtx.moveTo(0, 0);
        this.persistenceCtx.lineTo(sweepLength, 0);
        this.persistenceCtx.stroke();
        this.persistenceCtx.restore();
    }
    
    drawTracks() {
        this.tracks.forEach(track => {
            const x = this.centerX + track.x;
            const y = this.centerY + track.y;
            
            // Draw on persistence layer for trail effect
            this.persistenceCtx.fillStyle = this.phosphorSlow;
            this.persistenceCtx.beginPath();
            this.persistenceCtx.arc(x, y, 4, 0, Math.PI * 2);
            this.persistenceCtx.fill();
            
            // Draw bright spot on main canvas
            this.ctx.fillStyle = this.phosphorFast;
            this.ctx.shadowBlur = 15;
            this.ctx.shadowColor = this.phosphorSlow;
            this.ctx.beginPath();
            this.ctx.arc(x, y, 3, 0, Math.PI * 2);
            this.ctx.fill();
            this.ctx.shadowBlur = 0;
        });
    }
    
    updateTracks(tracks) {
        this.tracks = tracks || [];
    }
    
    updateOverlays(overlays) {
        this.overlays = new Set(overlays || []);
    }
    
    updateGeoData(geoData) {
        this.geoData = geoData;
    }
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', () => {
    console.log('[TEST] Initializing CRT radar...');
    window.crtRadar = new CRTRadarScope('radar-scope-canvas');
    console.log('[TEST] CRT radar started!');
});
    </script>
</body>
</html>

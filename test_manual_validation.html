<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGE Manual Figure Validation</title>
    <style>
        body {
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        h1 {
            color: #00ff00;
            text-align: center;
        }
        .subtitle {
            color: #888;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        .section {
            margin: 30px 0;
        }
        .section h2 {
            color: #0ff;
            border-bottom: 1px solid #0ff;
            padding-bottom: 5px;
        }
        #canvas {
            display: block;
            margin: 20px auto;
            border: 2px solid #00ff00;
            background-color: #000;
        }
        .controls {
            text-align: center;
            margin: 20px;
        }
        .controls label {
            margin: 0 10px;
            color: #0f0;
        }
        .info {
            color: #888;
            text-align: center;
            font-size: 0.9em;
            margin: 10px;
        }
        .validation-checklist {
            background-color: #111;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 20px auto;
            max-width: 900px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .pending { color: #ff0; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #222;
            color: #0ff;
        }
    </style>
</head>
<body>
    <h1>AN/FSQ-7 Manual Figure Validation</h1>
    <div class="subtitle">
        Priority 8 Task 6: Validation against C702-416L-ST Manual Figures 4-5, 4-8, 4-11, 4-12
    </div>
    
    <canvas id="canvas" width="1400" height="1000"></canvas>
    
    <div class="controls">
        <label>
            View:
            <select id="viewMode" onchange="renderView()">
                <option value="examples">Manual Examples (Figure 4-8)</option>
                <option value="spacing">Character Spacing Tests</option>
                <option value="features">Feature Layout Tests</option>
                <option value="clutter">Multi-Track Clutter Test</option>
            </select>
        </label>
        <button onclick="renderView()">Refresh</button>
    </div>
    
    <div class="validation-checklist" id="validationResults">
        Initializing validation...
    </div>

    <script src="dot_matrix_font.js"></script>
    <script src="tabular_track_display.js"></script>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const color = 'rgba(0, 255, 100, 1.0)';
        
        // Manual examples from Figure 4-8
        const manualExamples = [
            { text: 'FPTKG', desc: 'Figure 4-8 Example 1' },
            { text: 'GRB',   desc: 'Figure 4-8 Example 2' },
            { text: 'GR 8',  desc: 'Figure 4-8 Example 3' },
            { text: 'C 6',   desc: 'Figure 4-8 Example 4' }
        ];
        
        // Spacing specifications from manual
        const spacingSpecs = {
            charSpacing: 4,   // 4px between characters
            rowSpacing: 8,    // 8px between feature rows
            dotSize: 2,       // 2px dot radius
            dotSpacing: 1,    // 1px between dots
            charWidth: 5,     // 5 columns
            charHeight: 7     // 7 rows
        };
        
        function clearCanvas() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        function renderManualExamples() {
            clearCanvas();
            
            // Title
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 16px monospace';
            ctx.fillText('Manual Examples from Figure 4-8', 20, 30);
            
            ctx.font = '12px monospace';
            ctx.fillStyle = 'rgba(200, 200, 200, 0.7)';
            ctx.fillText('Reference: C702-416L-ST Situation Display Generator Element', 20, 50);
            
            // Render each example
            const startY = 100;
            const spacing = 100;
            
            manualExamples.forEach((example, index) => {
                const x = 100;
                const y = startY + (index * spacing);
                
                // Label
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '14px monospace';
                ctx.fillText(`${example.desc}:`, x - 80, y + 10);
                
                // Render the example text
                window.DotMatrixFont.renderString(ctx, example.text, x, y, color, 1.0, spacingSpecs.charSpacing);
                
                // Show dimensions
                const width = window.DotMatrixFont.getStringWidth(example.text, spacingSpecs.charSpacing);
                const dims = window.DotMatrixFont.getCharDimensions();
                
                ctx.fillStyle = 'rgba(150, 150, 150, 0.6)';
                ctx.font = '11px monospace';
                ctx.fillText(`String: "${example.text}"  Width: ${width}px  Height: ${dims.height}px`, x + width + 20, y + 10);
            });
            
            // Add spacing reference
            const refY = startY + (manualExamples.length * spacing) + 50;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = 'bold 14px monospace';
            ctx.fillText('Character Matrix Specifications:', 20, refY);
            
            ctx.font = '12px monospace';
            ctx.fillStyle = 'rgba(200, 200, 200, 0.7)';
            const specs = [
                `Character size: ${spacingSpecs.charWidth}×${spacingSpecs.charHeight} (columns × rows)`,
                `Dot size: ${spacingSpecs.dotSize}px radius`,
                `Dot spacing: ${spacingSpecs.dotSpacing}px between dots`,
                `Character spacing: ${spacingSpecs.charSpacing}px between chars`,
                `Feature row spacing: ${spacingSpecs.rowSpacing}px between rows`
            ];
            
            specs.forEach((spec, i) => {
                ctx.fillText(`• ${spec}`, 40, refY + 30 + (i * 20));
            });
        }
        
        function renderSpacingTests() {
            clearCanvas();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 16px monospace';
            ctx.fillText('Character and Row Spacing Validation', 20, 30);
            
            const testStrings = [
                'ABCDEFGHIJ',
                '0123456789',
                'TEST SPACING',
                'SAGE SYSTEM'
            ];
            
            const startX = 100;
            let y = 100;
            
            testStrings.forEach((str, index) => {
                // Label
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = '12px monospace';
                ctx.fillText(`Row ${index + 1}:`, startX - 70, y + 10);
                
                // Render string
                window.DotMatrixFont.renderString(ctx, str, startX, y, color, 1.0, spacingSpecs.charSpacing);
                
                // Show measurements
                const width = window.DotMatrixFont.getStringWidth(str, spacingSpecs.charSpacing);
                ctx.fillStyle = 'rgba(150, 150, 150, 0.6)';
                ctx.font = '11px monospace';
                ctx.fillText(`Width: ${width}px (${str.length} chars)`, startX + width + 20, y + 10);
                
                // Draw spacing markers
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 2]);
                
                // Vertical lines between characters
                let charX = startX;
                const charDims = window.DotMatrixFont.getCharDimensions();
                for (let i = 0; i < str.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(charX + charDims.width, y - 5);
                    ctx.lineTo(charX + charDims.width, y + charDims.height + 5);
                    ctx.stroke();
                    charX += charDims.width + spacingSpecs.charSpacing;
                }
                ctx.setLineDash([]);
                
                y += charDims.height + spacingSpecs.rowSpacing;
            });
        }
        
        function renderFeatureLayoutTests() {
            clearCanvas();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 16px monospace';
            ctx.fillText('5-Feature Tabular Layout Tests (A/B/C/D/E)', 20, 30);
            
            // Create sample tracks with different configurations
            const testTracks = [
                {
                    name: 'Hostile Bomber',
                    x: 350, y: 250,
                    track: window.TabularTrackDisplay.formatTrackForDisplay({
                        id: 'BM01', x: 0.3, y: 0.3, altitude: 35000, speed: 450,
                        heading: 270, track_type: 'bomber', threat_level: 'HIGH'
                    })
                },
                {
                    name: 'Friendly Fighter',
                    x: 1050, y: 250,
                    track: window.TabularTrackDisplay.formatTrackForDisplay({
                        id: 'F106', x: 0.7, y: 0.3, altitude: 45000, speed: 900,
                        heading: 45, track_type: 'friendly', threat_level: 'LOW'
                    })
                },
                {
                    name: 'Unknown Track',
                    x: 350, y: 650,
                    track: window.TabularTrackDisplay.formatTrackForDisplay({
                        id: 'UN99', x: 0.3, y: 0.7, altitude: 28000, speed: 320,
                        heading: 180, track_type: 'unknown', threat_level: 'MEDIUM'
                    })
                },
                {
                    name: 'Missile',
                    x: 1050, y: 650,
                    track: window.TabularTrackDisplay.formatTrackForDisplay({
                        id: 'MS03', x: 0.7, y: 0.7, altitude: 25000, speed: 750,
                        heading: 315, track_type: 'missile', threat_level: 'CRITICAL'
                    })
                }
            ];
            
            testTracks.forEach(test => {
                // Label
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.font = 'bold 14px monospace';
                ctx.fillText(test.name, test.x - 60, test.y - 80);
                
                // Show features
                ctx.font = '11px monospace';
                ctx.fillStyle = 'rgba(200, 200, 200, 0.6)';
                const features = test.track.features;
                ctx.fillText(`A:[${features.A}] B:[${features.B}]`, test.x - 60, test.y - 60);
                ctx.fillText(`C:[${features.C}] D:[${features.D}]`, test.x - 60, test.y - 45);
                
                // Render track
                window.TabularTrackDisplay.renderTrack(ctx, test.track, test.x, test.y, color, 1.0);
            });
        }
        
        function renderClutterTest() {
            clearCanvas();
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 16px monospace';
            ctx.fillText('Multi-Track Clutter Handling Test (20 tracks)', 20, 30);
            
            // Generate 20 random tracks with various parameters
            const numTracks = 20;
            const types = ['hostile', 'friendly', 'unknown', 'missile'];
            const threats = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
            
            for (let i = 0; i < numTracks; i++) {
                const x = 200 + (Math.random() * 1000);
                const y = 150 + (Math.random() * 700);
                const heading = Math.floor(Math.random() * 360);
                const speed = 200 + Math.floor(Math.random() * 700);
                const altitude = 10000 + Math.floor(Math.random() * 40000);
                const type = types[Math.floor(Math.random() * types.length)];
                const threat = threats[Math.floor(Math.random() * threats.length)];
                
                const track = window.TabularTrackDisplay.formatTrackForDisplay({
                    id: `T${i.toString().padStart(2, '0')}`,
                    x: x / canvas.width,
                    y: y / canvas.height,
                    altitude: altitude,
                    speed: speed,
                    heading: heading,
                    track_type: type,
                    threat_level: threat
                });
                
                // Render with slight alpha variation for depth
                const alpha = 0.7 + (Math.random() * 0.3);
                window.TabularTrackDisplay.renderTrack(ctx, track, x, y, color, alpha);
            }
            
            // Stats
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '12px monospace';
            ctx.fillText(`Total tracks: ${numTracks}`, 20, canvas.height - 40);
            ctx.fillText('Verify: Position modes avoid overlap, vectors don\'t cross features', 20, canvas.height - 20);
        }
        
        function generateValidationReport() {
            const results = {
                passed: 0,
                total: 0,
                checks: []
            };
            
            // Check 1: Character dimensions
            const dims = window.DotMatrixFont.getCharDimensions();
            const check1 = dims.width === 5 && dims.height === 7;
            results.checks.push({
                name: 'Character Dimensions',
                expected: '5×7',
                actual: `${dims.width}×${dims.height}`,
                pass: check1
            });
            results.total++;
            if (check1) results.passed++;
            
            // Check 2: Feature A length
            const testTrack = window.TabularTrackDisplay.formatTrackForDisplay({
                id: 'TEST', x: 0.5, y: 0.5, altitude: 35000, speed: 450,
                heading: 270, track_type: 'hostile', threat_level: 'HIGH'
            });
            const check2 = testTrack.features.A.length === 4;
            results.checks.push({
                name: 'Feature A Length',
                expected: '4 chars',
                actual: `${testTrack.features.A.length} chars`,
                pass: check2
            });
            results.total++;
            if (check2) results.passed++;
            
            // Check 3: Feature B length
            const check3 = testTrack.features.B.length === 4;
            results.checks.push({
                name: 'Feature B Length',
                expected: '4 chars',
                actual: `${testTrack.features.B.length} chars`,
                pass: check3
            });
            results.total++;
            if (check3) results.passed++;
            
            // Check 4: Feature C length
            const check4 = testTrack.features.C.length === 4;
            results.checks.push({
                name: 'Feature C Length',
                expected: '4 chars',
                actual: `${testTrack.features.C.length} chars`,
                pass: check4
            });
            results.total++;
            if (check4) results.passed++;
            
            // Check 5: Feature D length
            const check5 = testTrack.features.D.length === 2;
            results.checks.push({
                name: 'Feature D Length',
                expected: '2 chars',
                actual: `${testTrack.features.D.length} chars`,
                pass: check5
            });
            results.total++;
            if (check5) results.passed++;
            
            // Check 6: Manual examples renderable
            const check6 = manualExamples.every(ex => {
                const width = window.DotMatrixFont.getStringWidth(ex.text, 4);
                return width > 0;
            });
            results.checks.push({
                name: 'Manual Examples',
                expected: 'All renderable',
                actual: check6 ? 'All render correctly' : 'Some fail',
                pass: check6
            });
            results.total++;
            if (check6) results.passed++;
            
            // Check 7: Position modes
            const check7 = testTrack.positionMode >= 0 && testTrack.positionMode <= 3;
            results.checks.push({
                name: 'Position Mode Range',
                expected: '0-3',
                actual: `${testTrack.positionMode}`,
                pass: check7
            });
            results.total++;
            if (check7) results.passed++;
            
            return results;
        }
        
        function renderView() {
            const mode = document.getElementById('viewMode').value;
            
            switch (mode) {
                case 'examples':
                    renderManualExamples();
                    break;
                case 'spacing':
                    renderSpacingTests();
                    break;
                case 'features':
                    renderFeatureLayoutTests();
                    break;
                case 'clutter':
                    renderClutterTest();
                    break;
            }
            
            updateValidationReport();
        }
        
        function updateValidationReport() {
            const results = generateValidationReport();
            const resultsDiv = document.getElementById('validationResults');
            
            let html = '<h3>Validation Checklist</h3>';
            html += '<table>';
            html += '<tr><th>Check</th><th>Expected</th><th>Actual</th><th>Status</th></tr>';
            
            results.checks.forEach(check => {
                const statusClass = check.pass ? 'pass' : 'fail';
                const statusText = check.pass ? '✓ PASS' : '✗ FAIL';
                html += `<tr>
                    <td>${check.name}</td>
                    <td>${check.expected}</td>
                    <td>${check.actual}</td>
                    <td class="${statusClass}">${statusText}</td>
                </tr>`;
            });
            
            html += '</table>';
            html += `<div style="margin-top: 15px; font-size: 1.1em;">`;
            html += `<strong>Results: ${results.passed}/${results.total} checks passed</strong>`;
            html += `</div>`;
            
            if (results.passed === results.total) {
                html += '<div class="pass" style="margin-top: 10px; font-size: 1.1em;">✓ All validation checks passed! Display system matches SAGE specifications.</div>';
            } else {
                html += '<div class="fail" style="margin-top: 10px;">Some checks failed - review implementation</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        // Initial render
        renderView();
        
        console.log('[Manual Validation] Test page loaded');
        console.log('[Manual Validation] Reference: C702-416L-ST Figures 4-5, 4-8, 4-11, 4-12');
    </script>
</body>
</html>

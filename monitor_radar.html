<!DOCTYPE html>
<html>
<head>
    <title>Radar Monitor</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .timestamp { color: #ff0; }
        .good { color: #0f0; }
        .bad { color: #f00; }
        #screenshots { margin-top: 20px; }
        .screenshot-container {
            display: inline-block;
            margin: 10px;
            border: 2px solid #0f0;
            padding: 5px;
        }
        .screenshot-container img {
            display: block;
            width: 400px;
            height: 400px;
        }
        .screenshot-label {
            text-align: center;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h2>SAGE Radar Monitor - 60 Second Test</h2>
    <div id="status">Initializing...</div>
    <div id="log"></div>
    <div id="screenshots"></div>
    
    <script>
        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const screenshotsDiv = document.getElementById('screenshots');
        
        function log(message, isGood = null) {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = isGood === true ? 'good' : isGood === false ? 'bad' : '';
            logDiv.innerHTML += `<div><span class="timestamp">[${timestamp}]</span> <span class="${colorClass}">${message}</span></div>`;
        }
        
        async function captureRadarState() {
            try {
                const response = await fetch('http://localhost:3000/');
                const html = await response.text();
                
                // Parse for radar elements
                const hasCanvas = html.includes('id="radar-scope-canvas"');
                const hasCRTScript = html.includes('CRTRadarScope');
                const hasInit = html.includes('new CRTRadarScope');
                
                return {
                    hasCanvas,
                    hasCRTScript,
                    hasInit,
                    timestamp: Date.now()
                };
            } catch (error) {
                return {
                    error: error.message,
                    timestamp: Date.now()
                };
            }
        }
        
        async function captureScreenshot(label, elapsed) {
            // Open the page in an iframe to capture it
            const iframe = document.createElement('iframe');
            iframe.src = 'http://localhost:3000/';
            iframe.style.width = '800px';
            iframe.style.height = '800px';
            iframe.style.position = 'absolute';
            iframe.style.left = '-10000px';
            document.body.appendChild(iframe);
            
            return new Promise((resolve) => {
                iframe.onload = async () => {
                    await new Promise(r => setTimeout(r, 1000)); // Wait for render
                    
                    try {
                        const canvas = iframe.contentDocument.getElementById('radar-scope-canvas');
                        if (canvas) {
                            const dataUrl = canvas.toDataURL('image/png');
                            
                            const container = document.createElement('div');
                            container.className = 'screenshot-container';
                            
                            const img = document.createElement('img');
                            img.src = dataUrl;
                            
                            const labelDiv = document.createElement('div');
                            labelDiv.className = 'screenshot-label';
                            labelDiv.textContent = `${label} (${elapsed}s)`;
                            
                            container.appendChild(img);
                            container.appendChild(labelDiv);
                            screenshotsDiv.appendChild(container);
                            
                            log(`Screenshot captured: ${label}`, true);
                        } else {
                            log(`Canvas not found for: ${label}`, false);
                        }
                    } catch (error) {
                        log(`Screenshot error: ${error.message}`, false);
                    }
                    
                    document.body.removeChild(iframe);
                    resolve();
                };
            });
        }
        
        async function runMonitoring() {
            const startTime = Date.now();
            const intervals = [0, 15, 30, 45, 60]; // seconds
            
            statusDiv.textContent = 'Monitoring radar over 60 seconds...';
            log('Starting 60-second radar monitoring test');
            
            for (const interval of intervals) {
                const waitTime = interval * 1000;
                const elapsed = Math.round((Date.now() - startTime) / 1000);
                
                if (interval > 0) {
                    statusDiv.textContent = `Waiting for ${interval}s mark... (elapsed: ${elapsed}s)`;
                    await new Promise(resolve => setTimeout(resolve, waitTime - (Date.now() - startTime)));
                }
                
                const actualElapsed = Math.round((Date.now() - startTime) / 1000);
                statusDiv.textContent = `Capturing at ${actualElapsed}s...`;
                
                // Check state
                const state = await captureRadarState();
                if (state.error) {
                    log(`[${actualElapsed}s] ERROR: ${state.error}`, false);
                } else {
                    log(`[${actualElapsed}s] Canvas:${state.hasCanvas ? '✓' : '✗'} Script:${state.hasCRTScript ? '✓' : '✗'} Init:${state.hasInit ? '✓' : '✗'}`, 
                        state.hasCanvas && state.hasCRTScript);
                }
                
                // Capture screenshot
                await captureScreenshot(`T+${actualElapsed}s`, actualElapsed);
            }
            
            statusDiv.textContent = '✓ Monitoring complete!';
            log('Monitoring complete - check screenshots above', true);
        }
        
        // Start monitoring after 2 seconds
        setTimeout(runMonitoring, 2000);
    </script>
</body>
</html>
